<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persona Management - User Behavior Simulator</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <a href="/" class="text-xl font-bold text-gray-900">ðŸ§ª User Behavior Simulator</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md">Dashboard</a>
                    <a href="/simulator" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">New Simulation</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 px-4">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Persona Management</h1>
                <p class="text-gray-600">Create and manage user personas for behavior simulations</p>
            </div>
            <button onclick="openCreateModal()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                <i class="fas fa-plus mr-2"></i>Create Persona
            </button>
        </div>

        <!-- Personas Grid -->
        <div id="personas-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Personas will be loaded here -->
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="persona-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
                <div class="flex items-center justify-between mb-4">
                    <h3 id="modal-title" class="text-lg font-medium text-gray-900">Create New Persona</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="persona-form" class="space-y-4">
                    <input type="hidden" id="persona-id" name="id">
                    
                    <!-- Name -->
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                        <input type="text" id="name" name="name" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="e.g., Tech-Savvy Shopper">
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="description" name="description" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="Brief description of this persona"></textarea>
                    </div>

                    <!-- Tech Savviness -->
                    <div>
                        <label for="tech-savviness" class="block text-sm font-medium text-gray-700 mb-1">Tech Savviness (1-5)</label>
                        <select id="tech-savviness" name="tech_savviness" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="1">1 - Very Low</option>
                            <option value="2">2 - Low</option>
                            <option value="3" selected>3 - Average</option>
                            <option value="4">4 - High</option>
                            <option value="5">5 - Very High</option>
                        </select>
                    </div>

                    <!-- Intent -->
                    <div>
                        <label for="intent" class="block text-sm font-medium text-gray-700 mb-1">Intent</label>
                        <input type="text" id="intent" name="intent" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Primary motivation or goal">
                    </div>

                    <!-- Traits -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Behavioral Traits</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center">
                                <input type="checkbox" name="traits" value="impatient" class="mr-2">
                                <span class="text-sm">Impatient</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="traits" value="careful" class="mr-2">
                                <span class="text-sm">Careful</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="traits" value="mobile-first" class="mr-2">
                                <span class="text-sm">Mobile-first</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="traits" value="price-conscious" class="mr-2">
                                <span class="text-sm">Price-conscious</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="traits" value="social-proof-driven" class="mr-2">
                                <span class="text-sm">Social-proof driven</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="traits" value="help-seeking" class="mr-2">
                                <span class="text-sm">Help-seeking</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="traits" value="detail-oriented" class="mr-2">
                                <span class="text-sm">Detail-oriented</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="traits" value="skeptical" class="mr-2">
                                <span class="text-sm">Skeptical</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="traits" value="hurried" class="mr-2">
                                <span class="text-sm">Hurried</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="traits" value="practical" class="mr-2">
                                <span class="text-sm">Practical</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="traits" value="accessibility-dependent" class="mr-2">
                                <span class="text-sm">Accessibility-dependent</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="traits" value="goal-oriented" class="mr-2">
                                <span class="text-sm">Goal-oriented</span>
                            </label>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeModal()" 
                                class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                            Cancel
                        </button>
                        <button type="submit" id="submit-btn"
                                class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            Create Persona
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let personas = [];
        let isEditing = false;

        document.addEventListener('DOMContentLoaded', function() {
            loadPersonas();
        });

        async function loadPersonas() {
            try {
                const response = await fetch('/api/personas');
                personas = await response.json();
                renderPersonas();
            } catch (error) {
                console.error('Error loading personas:', error);
            }
        }

        function renderPersonas() {
            const grid = document.getElementById('personas-grid');
            
            if (personas.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-users text-4xl text-gray-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No personas yet</h3>
                        <p class="text-gray-600 mb-4">Create your first persona to get started with behavior simulations</p>
                        <button onclick="openCreateModal()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>Create Persona
                        </button>
                    </div>
                `;
                return;
            }

            grid.innerHTML = personas.map(persona => `
                <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <div>
                                <h3 class="font-medium text-gray-900">${persona.name}</h3>
                                <p class="text-sm text-gray-500">Tech Level: ${persona.tech_savviness}/5</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editPersona('${persona.id}')" 
                                    class="text-gray-400 hover:text-blue-600" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deletePersona('${persona.id}')" 
                                    class="text-gray-400 hover:text-red-600" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <p class="text-sm text-gray-600 mb-3">${persona.description}</p>

                    <div class="flex flex-wrap gap-1 mb-3">
                        ${persona.traits.slice(0, 4).map(trait => 
                            `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">${trait}</span>`
                        ).join('')}
                        ${persona.traits.length > 4 ? 
                            `<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs">+${persona.traits.length - 4} more</span>` : ''
                        }
                    </div>

                    <div class="border-t pt-3">
                        <p class="text-xs text-gray-500">
                            <strong>Intent:</strong> ${persona.intent}
                        </p>
                        <p class="text-xs text-gray-400 mt-1">
                            Created ${new Date(persona.created_at).toLocaleDateString()}
                        </p>
                    </div>
                </div>
            `).join('');
        }

        function openCreateModal() {
            isEditing = false;
            document.getElementById('modal-title').textContent = 'Create New Persona';
            document.getElementById('submit-btn').textContent = 'Create Persona';
            document.getElementById('persona-form').reset();
            document.getElementById('persona-id').value = '';
            document.getElementById('persona-modal').classList.remove('hidden');
        }

        function editPersona(personaId) {
            const persona = personas.find(p => p.id === personaId);
            if (!persona) return;

            isEditing = true;
            document.getElementById('modal-title').textContent = 'Edit Persona';
            document.getElementById('submit-btn').textContent = 'Update Persona';

            // Populate form
            document.getElementById('persona-id').value = persona.id;
            document.getElementById('name').value = persona.name;
            document.getElementById('description').value = persona.description;
            document.getElementById('tech-savviness').value = persona.tech_savviness;
            document.getElementById('intent').value = persona.intent;

            // Set traits checkboxes
            const traitCheckboxes = document.querySelectorAll('input[name="traits"]');
            traitCheckboxes.forEach(checkbox => {
                checkbox.checked = persona.traits.includes(checkbox.value);
            });

            document.getElementById('persona-modal').classList.remove('hidden');
        }

        async function deletePersona(personaId) {
            if (!confirm('Are you sure you want to delete this persona?')) return;

            try {
                const response = await fetch(`/api/personas/${personaId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadPersonas();
                } else {
                    alert('Failed to delete persona');
                }
            } catch (error) {
                console.error('Error deleting persona:', error);
                alert('Failed to delete persona');
            }
        }

        function closeModal() {
            document.getElementById('persona-modal').classList.add('hidden');
        }

        // Handle form submission
        document.getElementById('persona-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const traits = Array.from(formData.getAll('traits'));

            const personaData = {
                name: formData.get('name'),
                description: formData.get('description'),
                tech_savviness: parseInt(formData.get('tech_savviness')),
                intent: formData.get('intent'),
                traits: traits
            };

            try {
                let response;
                if (isEditing) {
                    const personaId = formData.get('id');
                    response = await fetch(`/api/personas/${personaId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(personaData)
                    });
                } else {
                    response = await fetch('/api/personas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(personaData)
                    });
                }

                if (response.ok) {
                    closeModal();
                    await loadPersonas();
                } else {
                    const error = await response.json();
                    alert('Failed to save persona: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving persona:', error);
                alert('Failed to save persona');
            }
        });

        // Close modal when clicking outside
        document.getElementById('persona-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>
